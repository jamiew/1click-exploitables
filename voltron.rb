require 'rubygems'
require 'mechanize'

# url = "http://knowyourmeme.com/memes/exploitables"
url = "file://#{File.dirname(File.expand_path(__FILE__))}/exploitables.html"
STDERR.puts "url= #{url}"
agent = WWW::Mechanize.new
page = agent.get(url)
exit 1 if page.nil? or page.body.empty?

# Fetch things from Know Your Meme
photos = []
links = (page/'.entry_photos a')
links.each do |photo|
  image = (photo/'img').to_s
  pkg = { :image => image, :href => photo['href'] }
  # STDERR.puts pkg.inspect
  photos << pkg
end

# Add our custom titles (from yaml)
# ...

# Render output!
puts <<-HTML
<html>
<head>
  <title>Instant Exploitable</title>
  <link rel="stylesheet" type="text/css" href="stylesheet.css" />
</head>
<body>
  <h1>ONE-CLICK EXPLOITABLES</h1>
  
  #{
  (page/'.entry_photos li.image').map { |li|
    (li/'p.by').remove
    a = (li/'a')[0]
    a['href'] = "http://aviary.com/flash/aviary/index.aspx?tid=1&phoenix&apil=3ea26caf2&loadurl=http://knowyourmeme"+a['href']+".jpg"
    a['target'] = "_blank"
    li
  }}
  
</body>
</html>
HTML

exit 0